AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: AWS SAM template for poc-parquet-publisher.

Resources:
  ParquetDataQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "parquet-data-queue-${AWS::StackName}"
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt ParquetDataDeadLetterQueue.Arn
        maxReceiveCount: 5
  ParquetDataDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub "parquet-data-deadletter-${AWS::StackName}"

  DuckDBRecordProcessorFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
    Properties:
      FunctionName: !Sub "duckdb-record-processor-${AWS::StackName}"
      Handler: bootstrap
      Runtime: provided.al2023
      CodeUri: cmd/duckdb-record-processor
      Environment:
        Variables:
          QUEUE_URL: !Ref ParquetDataQueue
      Policies:
        - SQSSendMessagePolicy:
            QueueName: !GetAtt ParquetDataQueue.QueueName
        - Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
              Resource: !Sub "arn:aws:s3:::${ParquetDataBucket}/*"

  SQSRecordConsumerFunction:
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: go1.x
    Properties:
      FunctionName: !Sub "sqs-record-consumer-${AWS::StackName}"
      Handler: bootstrap
      Runtime: provided.al2023
      CodeUri: cmd/sqs-record-consumer
    Policies:
      - SQSPollerPolicy:
          QueueName: !GetAtt ParquetDataQueue.QueueName
    Events:
      ParquetDataQueue:
        Type: SQS
        Properties:
          Queue: !GetAtt ParquetDataQueue.Arn

  ParquetDataBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "parquet-data-bucket-${AWS::StackName}"
